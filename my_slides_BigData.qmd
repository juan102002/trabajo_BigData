---
title: "La vivienda, una mirada a Europa y a España"  #- título
date: 2025-12-16              #- ISO8601 YYYY-MM-DD format 
date-format: short
format: 
  revealjs:
    scrollable: true
    slide-level: 2
    height: 900
    width: 1600
    toc: false
    center-title-slide: true
    title-slide-attributes: #- atributos para la slide de titulo
      data-background-color: "#562457"   #- color de R-ladies
    preview-links: auto  #- true: abre un iframe en lugar de abrir ventana
    link-external-newwindow: true
    transition: fade
    fontcolor: "#262d36"
    highlight-style: a11y
    code-line-numbers: true
    number-sections: false
    slide-number: c/t  
    incremental: false   
execute: 
  echo: true   
  eval: true     
  warning: false 
  message: false
footer: |
  Slides hechas con [Quarto y con sueño](https://quarto.org/) 
theme: night
---



## Intro 

Vamos a utilizar datos de:

- Eurostat

. . .

- La  OECD

. . .

- El INE

. . .

*los paquetes han sido cargados en un chunk de codigo que no se ve gracias a "include: false".
```{r}
#| include: false
#| message: false
#| warning: false
#install.packages("eurostat")
#install.packages("tidyverse")
#install.packages("ggplot2")
#install.packages("gganimate")
#install.packages("ggthemes")
#install.packages("gt")
#install.packages("gtExtras")
#install.packages("tidyr")
#install.packages("sf")
#install.packages("giscoR")
#install.packages("ragg")
#install.packages("gifski")
#install.packages("lubridate")
#install.packages("DT")
#install.packages("pjpv.curso.R.2022")
#install.packages("classInt")
#install.packages("stringr")
#install.packages("pxR")
#install.packages("devtools")

library(pxR)
library(eurostat)
library(tidyverse)
library(ggplot2)
library(gganimate)
library(ggthemes)
library(gt)
library(gtExtras)
library(tidyr)
library(sf)        
library(giscoR)
library(ragg)

library(lubridate)
library(DT)
devtools::install_github("perezp44/pjpv.curso.R.2022")
library(classInt)
library(stringr)

#Usamos esto para solucionar problemas con los gráficos animados
library(gifski)
```

## En Europa donde sube y donde no sube el precio del alquiler {background-color="grey"}

::: {.panel-tabset}
## Tabla 1 (mal)

```{r}
#| include: false
#| eval: true
#Escogemos los datos de la página de Eurostat
my_table <- "prc_hicp_aind"

eurostat::label_eurostat_tables(my_table)

#Creamos el dataframe asociado al índice de IPC de Eurostat y filtramos
df <- eurostat::get_eurostat(my_table, time_format = "raw")   
```

```{r}
#| echo: false
df_alquileres_index <- df %>%
                        filter(coicop == "CP041",
                        !geo %in% c("EU27_2020", "EA19", "EU28", 
                                    "EA", "EA20","EA19", "US", 
                                    "XK", "TR", "RS", "AL", "MK", 
                                    "ME", "UK", "EEA", "EU")) %>%
                        label_eurostat() %>%
                        filter(unit == "Annual average index") %>%
                        dplyr::rename(paises = geo,
                               año = TIME_PERIOD) %>%
                        mutate(año = as.numeric(año)) %>%
                        select(-freq) 

##Top (Los 6 que más han crecido desde 2015 hasta 2024)
df_alquileres_top_6_2024 <- df_alquileres_index %>%
                             filter(año == 2024) %>%
                             slice_max(values, n=6) 

tabla_df_alquileres_top_6_2024 <- df_alquileres_top_6_2024 %>%
                                   gt() %>%
                                   gt_theme_excel() %>% 
                                   tab_header(title = "Tabla 1: Incremento del precio del alquiler\nen los 6 países que más ha crecido",
                                               subtitle = "TOP 6") %>% 
                                   tab_footnote(footnote = "Eurostat 2025") 

tabla_df_alquileres_top_6_2024
```

Al pasar una tabla de un archivo html a formato slides es necesario realizar ajustes de tamaño de la tabla y el texto que ahi dentro de esta para que se vea bien.

## Tabla 2 (bien)

```{r}
#| echo: false
#Nontop (Los 6 que menos han crecido desde 2015 hasta 2024)
df_alquileres_nontop_6_2024 <- df_alquileres_index %>%
                                filter(año == 2024) %>%
                                slice_min(values, n=6)

tabla_df_alquileres_nontop_6_2024 <- df_alquileres_nontop_6_2024 %>%
                                gt() %>% 
                                gt_theme_excel() %>% 
                                tab_header(title = "Tabla 2: Incremento del precio del alquiler\nen los 6 países que menos ha crecido",
                                           subtitle = "NONTOP 6") %>% 
                                tab_footnote(footnote = "Eurostat 2025") %>%
                                  gt::tab_options(table.width = pct(100)) %>%
                                   tab_options(table.font.size = "18pt", heading.title.font.size = "30pt", data_row.padding = "8px") 

tabla_df_alquileres_nontop_6_2024
```

## Código correcto

```{r}
#| include: true
#| eval: false
#Nontop (Los 6 que menos han crecido desde 2015 hasta 2024)
df_alquileres_nontop_6_2024 <- df_alquileres_index %>%
                                filter(año == 2024) %>%
                                slice_min(values, n=6)

tabla_df_alquileres_nontop_6_2024 <- df_alquileres_nontop_6_2024 %>%
                                gt() %>% 
                                gt_theme_excel() %>% 
                                tab_header(title = "Tabla 2: Incremento del precio del alquiler\nen los 6 países que menos ha crecido",
                                           subtitle = "NONTOP 6") %>% 
                                tab_footnote(footnote = "Eurostat 2025") %>%
                                  tab_options(table.width = pct(100), table.font.size = "18pt", heading.title.font.size = "30pt", data_row.padding = "8px") 

tabla_df_alquileres_nontop_6_2024
```
:::

## Grafico y conclusiones
::: {.incremental}
:::: {.columns style="align-items: center;"}

::: {.column width="50%"}
```{r}
#| echo: false
#| fig-align: center
#| fig-height: 9
url_ocde <- "https://sdmx.oecd.org/public/rest/data/OECD.SDD.TPS,DSD_PRICES@DF_PRICES_ALL,1.0/CAN+AUS+BEL+FRA+DEU+ITA+JPN+NLD+ESP+CHE+SWE+GBR+USA+OECD+EU27_2020.A.N.CPI.IX.CP041.N.?startPeriod=1996&endPeriod=2024&dimensionAtObservation=AllDimensions&format=csvfilewithlabels"

#Creamos el archivo y descargamos los datos
dir.create("datos")

ruta_ocde <- "./datos/alquileres_ocde.csv"

curl::curl_download(url_ocde, ruta_ocde) 

alquileres_ocde <- read_csv(ruta_ocde)

#Filtramos los datos
alquileres_ocde <- alquileres_ocde %>%
                   select(Measure, BASE_PER, EXPENDITURE, Expenditure,                                         `Reference area`, TIME_PERIOD, OBS_VALUE) %>%
                   mutate(año = TIME_PERIOD,
                          values = OBS_VALUE,
                          país = `Reference area`)
  
#Creamos el gráfico 
gráfico <- ggplot(alquileres_ocde, aes(x = año, y = values, color = país)) +
            geom_line(size = 1.4) +
            labs(title = "Gráfico 7: Incremento del precio del alquiler (Base 2015) G-12", 
                  x = "Año", y = "Porcentaje (Base 2015)",
                 caption = "Fuente: OCDE 2025") +
            scale_x_continuous(breaks = seq(1996, 2024, by = 2)) +
            scale_y_continuous(breaks = seq(50, 150, by = 12.5),
                               limits = c(50, 150),
                               expand = c(0, 0)) +
            theme_stata() +
            theme(legend.position = "none",
                  axis.text.x = element_text(angle = 90, vjust = 0.5),
                  axis.text.y = element_text(angle = 0)) +
            geom_text(aes(label = país))
  
#Animámos el gráfico
gráfico_animado <- gráfico + transition_reveal(año)+
  enter_fade() + 
  exit_fade()

gráfico_animado
```

:::

::: {.column width="50%"}
- Vemos claramente como el año base es 2015.

<br>

- Japón (linea azul) no tiene apenas incremento en el precio de la vivienda.

<br>

- Estados Unidos (rosa), en cambio, lidera la carrera.

:::

::::
:::



## Grafico y conclusiones (con tabset)
::: {.incremental}

:::: {.columns style="align-items: center;"}

::: {.column width="50%"}

::: {.panel-tabset}

## Grafico

```{r}
#| echo: false
#| fig-align: center
#| fig-height: 9
url_ocde <- "https://sdmx.oecd.org/public/rest/data/OECD.SDD.TPS,DSD_PRICES@DF_PRICES_ALL,1.0/CAN+AUS+BEL+FRA+DEU+ITA+JPN+NLD+ESP+CHE+SWE+GBR+USA+OECD+EU27_2020.A.N.CPI.IX.CP041.N.?startPeriod=1996&endPeriod=2024&dimensionAtObservation=AllDimensions&format=csvfilewithlabels"

#Creamos el archivo y descargamos los datos
dir.create("datos")

ruta_ocde <- "./datos/alquileres_ocde.csv"

curl::curl_download(url_ocde, ruta_ocde) 

alquileres_ocde <- read_csv(ruta_ocde)

#Filtramos los datos
alquileres_ocde <- alquileres_ocde %>%
                   select(Measure, BASE_PER, EXPENDITURE, Expenditure,                                         `Reference area`, TIME_PERIOD, OBS_VALUE) %>%
                   mutate(año = TIME_PERIOD,
                          values = OBS_VALUE,
                          país = `Reference area`)
  
#Creamos el gráfico 
gráfico <- ggplot(alquileres_ocde, aes(x = año, y = values, color = país)) +
            geom_line(size = 1.4) +
            labs(title = "Gráfico 7: Incremento del precio del alquiler (Base 2015) G-12", 
                  x = "Año", y = "Porcentaje (Base 2015)",
                 caption = "Fuente: OCDE 2025") +
            scale_x_continuous(breaks = seq(1996, 2024, by = 2)) +
            scale_y_continuous(breaks = seq(50, 150, by = 12.5),
                               limits = c(50, 150),
                               expand = c(0, 0)) +
            theme_stata() +
            theme(legend.position = "none",
                  axis.text.x = element_text(angle = 90, vjust = 0.5),
                  axis.text.y = element_text(angle = 0)) +
            geom_text(aes(label = país))
  
#Animámos el gráfico
gráfico_animado <- gráfico + transition_reveal(año)+
  enter_fade() + 
  exit_fade()

gráfico_animado
```

## Código

```{r}
#| include: true
#| eval: false
#| fig-align: center
#| fig-height: 9
url_ocde <- "https://sdmx.oecd.org/public/rest/data/OECD.SDD.TPS,DSD_PRICES@DF_PRICES_ALL,1.0/CAN+AUS+BEL+FRA+DEU+ITA+JPN+NLD+ESP+CHE+SWE+GBR+USA+OECD+EU27_2020.A.N.CPI.IX.CP041.N.?startPeriod=1996&endPeriod=2024&dimensionAtObservation=AllDimensions&format=csvfilewithlabels"

#Creamos el archivo y descargamos los datos
dir.create("datos")

ruta_ocde <- "./datos/alquileres_ocde.csv"

curl::curl_download(url_ocde, ruta_ocde) 

alquileres_ocde <- read_csv(ruta_ocde)

#Filtramos los datos
alquileres_ocde <- alquileres_ocde %>%
                   select(Measure, BASE_PER, EXPENDITURE, Expenditure,                                         `Reference area`, TIME_PERIOD, OBS_VALUE) %>%
                   mutate(año = TIME_PERIOD,
                          values = OBS_VALUE,
                          país = `Reference area`)
  
#Creamos el gráfico 
gráfico <- ggplot(alquileres_ocde, aes(x = año, y = values, color = país)) +
            geom_line(size = 1.4) +
            labs(title = "Gráfico 7: Incremento del precio del alquiler (Base 2015) G-12", 
                  x = "Año", y = "Porcentaje (Base 2015)",
                 caption = "Fuente: OCDE 2025") +
            scale_x_continuous(breaks = seq(1996, 2024, by = 2)) +
            scale_y_continuous(breaks = seq(50, 150, by = 12.5),
                               limits = c(50, 150),
                               expand = c(0, 0)) +
            theme_stata() +
            theme(legend.position = "none",
                  axis.text.x = element_text(angle = 90, vjust = 0.5),
                  axis.text.y = element_text(angle = 0)) +
            geom_text(aes(label = país))
  
#Animámos el gráfico
gráfico_animado <- gráfico + transition_reveal(año)+
  enter_fade() + 
  exit_fade()

gráfico_animado
```

:::

:::

::: {.column width="50%"}
- Vemos claramente como el año base es 2015.

<br>

- Japón (linea azul) no tiene apenas incremento en el precio de la vivienda.

<br>

- Estados Unidos (rosa), en cambio, lidera la carrera.

:::

::::
:::

## Mapa dinámico

```{r}
#| include: false
#| eval: true
my_table <- "prc_hicp_aind"

eurostat::label_eurostat_tables(my_table)
```


```{r}
#| echo: false

df <- eurostat::get_eurostat(my_table, time_format = "raw") 

df_alquileres_anual <- df %>%
                        filter(coicop == "CP041",
                               unit == "RCH_A_AVG",
                        !geo %in% c("EU27_2020", "EA19", "EU28", 
                                     "EA", "EA20","EA19", "US", 
                                     "XK", "TR", "RS", "AL", "MK", 
                                     "ME", "UK", "EEA", "EU")) %>%
                         rename(país = geo,
                                año = TIME_PERIOD) %>%
                         select(-freq) %>%
                         mutate(año = as.numeric(año))

mapa_europa <- gisco_get_nuts(year = "2021", 
                              resolution = "20", 
                              nuts_level = 0) %>%
                rename(país = NUTS_ID)

mapa_animado_data <- mapa_europa %>%
                      inner_join(df_alquileres_anual, by = "país") %>%
                      mutate(incremento_alquileres_grupos = factor(ntile(values, 5),
                             labels = c("Muy baja", 
                                        "Baja", 
                                        "Moderado",
                                        "Alta", 
                                        "Muy alta")))

animacion <- ggplot(mapa_animado_data) +
              geom_sf(aes(fill = incremento_alquileres_grupos), 
                      color = "white", 
                      size = 0.1) +
              scale_fill_viridis_d(option = "magma", direction = -1, 
                       name = "Incremento del precio del alquiler (%)") + 
              theme_void() +
              coord_sf(xlim = c(-25, 45), ylim = c(34, 72)) +
              labs(title = "Mapa 1: Evolución del Incremento del alquiler entre 1996-2024 en la UE",
                   subtitle = "Año: {current_frame}",
                   caption = "Eurostat 2025") +
              transition_manual(año) +
              ease_aes("linear") 

animate(animacion, renderer = gifski_renderer(), 
        duration = 35, 
        fps = 25, 
        width = 1000,
        height = 600,
        units = "px",
        res = 150)
```



